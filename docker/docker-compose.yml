# Roam Protocol Conformance Test Infrastructure
#
# This compose file supports plugging in any Roam implementation.
# Set SERVER_CONTEXT/SERVER_DOCKERFILE and CLIENT_CONTEXT/CLIENT_DOCKERFILE
# to point to your implementation's build context.
#
# Default: Uses the stub implementation (docker/Dockerfile.stub) for testing
# the test infrastructure itself.
#
# Usage:
#   # Run with stub implementation
#   docker compose up -d
#
#   # Run with external implementation
#   SERVER_CONTEXT=/path/to/impl SERVER_DOCKERFILE=Dockerfile docker compose up -d
#
#   # Run with network chaos
#   docker compose --profile chaos up -d

services:
  # ===========================================================================
  # Core Services
  # ===========================================================================

  roam-server:
    build:
      context: ${SERVER_CONTEXT:-.}
      dockerfile: ${SERVER_DOCKERFILE:-Dockerfile.stub}
      target: ${SERVER_TARGET:-server}
    container_name: roam-server
    environment:
      - ROAM_MODE=server
      - ROAM_SERVER_PRIVATE_KEY=${SERVER_PRIVATE_KEY:-}
      - ROAM_SERVER_PUBLIC_KEY=${SERVER_PUBLIC_KEY:-}
      - ROAM_STATE_TYPE=${STATE_TYPE:-roam.echo.v1}
      - ROAM_LOG_LEVEL=${LOG_LEVEL:-debug}
      - ROAM_BIND_ADDR=0.0.0.0:19999
    networks:
      roam-net:
        ipv4_address: 172.28.0.10
    ports:
      - "19999:19999/udp"
      - "8080:8080"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 1s
      timeout: 1s
      retries: 30
      start_period: 5s
    restart: unless-stopped

  roam-client:
    build:
      context: ${CLIENT_CONTEXT:-.}
      dockerfile: ${CLIENT_DOCKERFILE:-Dockerfile.stub}
      target: ${CLIENT_TARGET:-client}
    container_name: roam-client
    environment:
      - ROAM_MODE=client
      - ROAM_SERVER_HOST=172.28.0.10
      - ROAM_SERVER_PORT=19999
      - ROAM_SERVER_PUBLIC_KEY=${SERVER_PUBLIC_KEY:-}
      - ROAM_LOG_LEVEL=${LOG_LEVEL:-debug}
    networks:
      roam-net:
        ipv4_address: 172.28.0.20
    depends_on:
      roam-server:
        condition: service_healthy
    stdin_open: true
    tty: true
    restart: unless-stopped

  # ===========================================================================
  # Observability Sidecars
  # ===========================================================================

  # Packet capture for wire-level tests
  tcpdump:
    image: nicolaka/netshoot:latest
    container_name: roam-tcpdump
    command: >
      tcpdump -i eth0 -w /capture/roam.pcap
      -U
      udp port 19999 or tcp port 8080
    network_mode: "service:roam-server"
    volumes:
      - ./capture:/capture
    cap_add:
      - NET_ADMIN
      - NET_RAW
    depends_on:
      - roam-server
    profiles:
      - capture

  # ===========================================================================
  # Network Chaos (for resilience testing)
  # ===========================================================================

  # Introduce network delays, packet loss, etc.
  chaos-delay:
    image: gaiaadm/pumba:latest
    container_name: roam-chaos-delay
    command: >
      netem
      --duration 300s
      --tc-image gaiadocker/iproute2
      delay
      --time 100
      --jitter 50
      roam-client
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - roam-client
    profiles:
      - chaos

  chaos-loss:
    image: gaiaadm/pumba:latest
    container_name: roam-chaos-loss
    command: >
      netem
      --duration 300s
      --tc-image gaiadocker/iproute2
      loss
      --percent 10
      roam-client
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - roam-client
    profiles:
      - chaos-loss

# ===========================================================================
# Networks
# ===========================================================================

networks:
  roam-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ===========================================================================
# Volumes
# ===========================================================================

volumes:
  capture:
    driver: local
