# Nomad Protocol Conformance Test Infrastructure
#
# This compose file uses pre-built images for testing implementations.
# Build images first with the implementation's build system, then run tests.
#
# For Rust implementation:
#   cd ../nomad-rs && just docker-server docker-client
#   Then: docker compose up -d
#
# Default images: nomad-echo-server (x86), nomad-client-arm (ARM64/QEMU)
#
# Usage:
#   # Start containers
#   docker compose up -d
#
#   # Run tests
#   uv run pytest ../tests/
#
#   # Stop containers
#   docker compose down
#
#   # With packet capture
#   docker compose --profile capture up -d
#
#   # With network chaos
#   docker compose --profile chaos up -d

services:
  # ===========================================================================
  # Core Services
  # ===========================================================================

  nomad-server:
    image: ${SERVER_IMAGE:-nomad-echo-server}
    container_name: nomad-server
    environment:
      - NOMAD_MODE=server
      - NOMAD_SERVER_PRIVATE_KEY=${SERVER_PRIVATE_KEY:-}
      - NOMAD_SERVER_PUBLIC_KEY=${SERVER_PUBLIC_KEY:-gqNRjwG8OsClvG2vWuafYeERaM95Pk0rTLmFAjh6JDo=}
      - NOMAD_STATE_TYPE=${STATE_TYPE:-nomad.echo.v1}
      - NOMAD_LOG_LEVEL=${LOG_LEVEL:-debug}
      - NOMAD_BIND_ADDR=0.0.0.0:19999
      - NOMAD_TEST_MODE=${TEST_MODE:-true}
    networks:
      nomad-net:
        ipv4_address: 172.28.0.10
    ports:
      - "19999:19999/udp"
      - "8080:8080"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 1s
      timeout: 1s
      retries: 30
      start_period: 5s
    restart: unless-stopped

  nomad-client:
    image: ${CLIENT_IMAGE:-nomad-client-arm}
    platform: ${CLIENT_PLATFORM:-linux/arm64}
    container_name: nomad-client
    environment:
      - NOMAD_MODE=client
      - NOMAD_SERVER_HOST=172.28.0.10
      - NOMAD_SERVER_PORT=19999
      - NOMAD_SERVER_PUBLIC_KEY=${SERVER_PUBLIC_KEY:-gqNRjwG8OsClvG2vWuafYeERaM95Pk0rTLmFAjh6JDo=}
      - NOMAD_LOG_LEVEL=${LOG_LEVEL:-debug}
    networks:
      nomad-net:
        ipv4_address: 172.28.0.20
    depends_on:
      nomad-server:
        condition: service_healthy
    stdin_open: true
    tty: true
    restart: unless-stopped

  # ===========================================================================
  # Observability Sidecars
  # ===========================================================================

  # Packet capture for wire-level tests
  tcpdump:
    image: nicolaka/netshoot:latest
    container_name: nomad-tcpdump
    command: >
      tcpdump -i eth0 -w /capture/nomad.pcap
      -U
      udp port 19999 or tcp port 8080
    network_mode: "service:nomad-server"
    volumes:
      - ./capture:/capture
    cap_add:
      - NET_ADMIN
      - NET_RAW
    depends_on:
      - nomad-server
    profiles:
      - capture

  # ===========================================================================
  # Network Chaos (for resilience testing)
  # ===========================================================================

  chaos-delay:
    image: gaiaadm/pumba:latest
    container_name: nomad-chaos-delay
    command: >
      netem
      --duration 300s
      --tc-image gaiadocker/iproute2
      delay
      --time 100
      --jitter 50
      nomad-client
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - nomad-client
    profiles:
      - chaos

  chaos-loss:
    image: gaiaadm/pumba:latest
    container_name: nomad-chaos-loss
    command: >
      netem
      --duration 300s
      --tc-image gaiadocker/iproute2
      loss
      --percent 10
      nomad-client
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - nomad-client
    profiles:
      - chaos-loss

  # 30% packet loss profile
  chaos-loss-30:
    image: gaiaadm/pumba:latest
    container_name: nomad-chaos-loss-30
    command: >
      netem
      --duration 300s
      --tc-image gaiadocker/iproute2
      loss
      --percent 30
      nomad-client
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - nomad-client
    profiles:
      - chaos-loss-30

  # 50% packet loss profile (critical test threshold)
  chaos-loss-50:
    image: gaiaadm/pumba:latest
    container_name: nomad-chaos-loss-50
    command: >
      netem
      --duration 300s
      --tc-image gaiadocker/iproute2
      loss
      --percent 50
      nomad-client
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - nomad-client
    profiles:
      - chaos-loss-50

  # Packet reordering profile
  chaos-reorder:
    image: gaiaadm/pumba:latest
    container_name: nomad-chaos-reorder
    command: >
      netem
      --duration 300s
      --tc-image gaiadocker/iproute2
      delay
      --time 10
      --reorder-percent 25
      --reorder-gap 5
      nomad-client
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - nomad-client
    profiles:
      - chaos-reorder

  # Packet duplication profile
  chaos-duplicate:
    image: gaiaadm/pumba:latest
    container_name: nomad-chaos-duplicate
    command: >
      netem
      --duration 300s
      --tc-image gaiadocker/iproute2
      duplicate
      --percent 20
      nomad-client
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - nomad-client
    profiles:
      - chaos-duplicate

  # High latency profile (500ms)
  chaos-latency-500:
    image: gaiaadm/pumba:latest
    container_name: nomad-chaos-latency-500
    command: >
      netem
      --duration 300s
      --tc-image gaiadocker/iproute2
      delay
      --time 500
      --jitter 50
      nomad-client
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - nomad-client
    profiles:
      - chaos-latency-500

  # High jitter profile (Â±300ms)
  chaos-jitter-extreme:
    image: gaiaadm/pumba:latest
    container_name: nomad-chaos-jitter-extreme
    command: >
      netem
      --duration 300s
      --tc-image gaiadocker/iproute2
      delay
      --time 100
      --jitter 300
      --distribution normal
      nomad-client
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - nomad-client
    profiles:
      - chaos-jitter-extreme

# ===========================================================================
# Networks
# ===========================================================================

networks:
  nomad-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ===========================================================================
# Volumes
# ===========================================================================

volumes:
  capture:
    driver: local
