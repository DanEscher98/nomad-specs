# Roam Protocol Interoperability Testing
#
# This compose file runs multiple server/client implementations simultaneously
# for cross-implementation testing.
#
# Usage:
#   # Set implementation paths
#   export RUST_IMPL_PATH=/path/to/rust/roam
#   export GO_IMPL_PATH=/path/to/go/roam
#
#   # Run interop tests
#   docker compose -f docker-compose.interop.yml up -d

services:
  # ===========================================================================
  # Rust Implementation
  # ===========================================================================

  rust-server:
    build:
      context: ${RUST_IMPL_PATH:-.}
      dockerfile: ${RUST_SERVER_DOCKERFILE:-Dockerfile}
      target: server
    container_name: roam-rust-server
    environment:
      - ROAM_MODE=server
      - ROAM_SERVER_PRIVATE_KEY=${SERVER_PRIVATE_KEY:-}
      - ROAM_SERVER_PUBLIC_KEY=${SERVER_PUBLIC_KEY:-}
      - ROAM_STATE_TYPE=${STATE_TYPE:-roam.echo.v1}
      - ROAM_LOG_LEVEL=debug
    networks:
      roam-interop:
        ipv4_address: 172.29.1.10
    ports:
      - "19001:19999/udp"
      - "8001:8080"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 1s
      timeout: 1s
      retries: 30

  rust-client:
    build:
      context: ${RUST_IMPL_PATH:-.}
      dockerfile: ${RUST_CLIENT_DOCKERFILE:-Dockerfile}
      target: client
    container_name: roam-rust-client
    environment:
      - ROAM_MODE=client
      - ROAM_SERVER_HOST=${INTEROP_SERVER_HOST:-172.29.1.10}
      - ROAM_SERVER_PORT=19999
      - ROAM_SERVER_PUBLIC_KEY=${SERVER_PUBLIC_KEY:-}
      - ROAM_LOG_LEVEL=debug
    networks:
      roam-interop:
        ipv4_address: 172.29.1.20
    depends_on:
      rust-server:
        condition: service_healthy
    profiles:
      - rust-to-rust

  # ===========================================================================
  # Go Implementation
  # ===========================================================================

  go-server:
    build:
      context: ${GO_IMPL_PATH:-.}
      dockerfile: ${GO_SERVER_DOCKERFILE:-Dockerfile}
      target: server
    container_name: roam-go-server
    environment:
      - ROAM_MODE=server
      - ROAM_SERVER_PRIVATE_KEY=${SERVER_PRIVATE_KEY:-}
      - ROAM_SERVER_PUBLIC_KEY=${SERVER_PUBLIC_KEY:-}
      - ROAM_STATE_TYPE=${STATE_TYPE:-roam.echo.v1}
      - ROAM_LOG_LEVEL=debug
    networks:
      roam-interop:
        ipv4_address: 172.29.2.10
    ports:
      - "19002:19999/udp"
      - "8002:8080"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 1s
      timeout: 1s
      retries: 30
    profiles:
      - go

  go-client:
    build:
      context: ${GO_IMPL_PATH:-.}
      dockerfile: ${GO_CLIENT_DOCKERFILE:-Dockerfile}
      target: client
    container_name: roam-go-client
    environment:
      - ROAM_MODE=client
      - ROAM_SERVER_HOST=${INTEROP_SERVER_HOST:-172.29.2.10}
      - ROAM_SERVER_PORT=19999
      - ROAM_SERVER_PUBLIC_KEY=${SERVER_PUBLIC_KEY:-}
      - ROAM_LOG_LEVEL=debug
    networks:
      roam-interop:
        ipv4_address: 172.29.2.20
    depends_on:
      go-server:
        condition: service_healthy
    profiles:
      - go-to-go

  # ===========================================================================
  # Cross-Implementation: Rust Client -> Go Server
  # ===========================================================================

  rust-client-go-server:
    build:
      context: ${RUST_IMPL_PATH:-.}
      dockerfile: ${RUST_CLIENT_DOCKERFILE:-Dockerfile}
      target: client
    container_name: roam-rust-client-go
    environment:
      - ROAM_MODE=client
      - ROAM_SERVER_HOST=172.29.2.10
      - ROAM_SERVER_PORT=19999
      - ROAM_SERVER_PUBLIC_KEY=${SERVER_PUBLIC_KEY:-}
      - ROAM_LOG_LEVEL=debug
    networks:
      roam-interop:
        ipv4_address: 172.29.3.20
    depends_on:
      go-server:
        condition: service_healthy
    profiles:
      - rust-to-go

  # ===========================================================================
  # Cross-Implementation: Go Client -> Rust Server
  # ===========================================================================

  go-client-rust-server:
    build:
      context: ${GO_IMPL_PATH:-.}
      dockerfile: ${GO_CLIENT_DOCKERFILE:-Dockerfile}
      target: client
    container_name: roam-go-client-rust
    environment:
      - ROAM_MODE=client
      - ROAM_SERVER_HOST=172.29.1.10
      - ROAM_SERVER_PORT=19999
      - ROAM_SERVER_PUBLIC_KEY=${SERVER_PUBLIC_KEY:-}
      - ROAM_LOG_LEVEL=debug
    networks:
      roam-interop:
        ipv4_address: 172.29.4.20
    depends_on:
      rust-server:
        condition: service_healthy
    profiles:
      - go-to-rust

networks:
  roam-interop:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/16
