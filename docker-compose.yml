services:
  roam-server:
    build:
      context: ${SERVER_CONTEXT:-.}
      dockerfile: ${SERVER_DOCKERFILE:-Dockerfile.server}
    environment:
      - ROAM_SERVER_PRIVATE_KEY=${SERVER_PRIVATE_KEY}
      - ROAM_SERVER_PUBLIC_KEY=${SERVER_PUBLIC_KEY}
      - ROAM_STATE_TYPE=${STATE_TYPE:-roam.echo.v1}
      - ROAM_LOG_LEVEL=debug
    networks:
      roam-net:
        ipv4_address: 172.28.0.10
    ports:
      - "19999:19999/udp"
      - "8080:8080"  # health check
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 1s
      timeout: 1s
      retries: 10

  roam-client:
    build:
      context: ${CLIENT_CONTEXT:-.}
      dockerfile: ${CLIENT_DOCKERFILE:-Dockerfile.client}
    environment:
      - ROAM_SERVER_HOST=172.28.0.10
      - ROAM_SERVER_PORT=19999
      - ROAM_SERVER_PUBLIC_KEY=${SERVER_PUBLIC_KEY}
      - ROAM_LOG_LEVEL=debug
    networks:
      roam-net:
        ipv4_address: 172.28.0.20
    depends_on:
      roam-server:
        condition: service_healthy
    stdin_open: true
    tty: true

  # Packet capture sidecar
  tcpdump:
    image: nicolaka/netshoot
    command: tcpdump -i eth0 -w /capture/roam.pcap udp port 19999
    network_mode: "service:roam-server"
    volumes:
      - ./capture:/capture
    cap_add:
      - NET_ADMIN
      - NET_RAW

  # Network chaos (optional)
  chaos:
    image: gaiaadm/pumba
    command: netem --duration 60s --tc-image gaiadocker/iproute2 delay --time 100 roam-client
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    profiles:
      - chaos  # Only runs with --profile chaos

networks:
  roam-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
